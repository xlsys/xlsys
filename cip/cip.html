<!DOCTYPE html>
<!--
IP地址查询工具
功能：
1. 支持输入IP地址查询地理位置、国家、城市等信息。
2. 页面加载时自动查询当前访问者的IP地址。
3. 支持IPv6地址查询。
4. 内置多个API作为备用查询源。
5. 支持通过URL参数mode=curl输出JSON格式的查询结果。
-->
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP地址查询 - 小柳实验室</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .container {
            text-align: center;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
        }
        h1 {
            color: #e74c3c;
            font-size: 2.5em;
            margin-bottom: 20px;
        }
        p {
            font-size: 1.2em;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        .ip-address, .ip-location, .visit-time, .ipv6-address {
            font-weight: bold;
            color: #3498db;
        }
        .footer {
            margin-top: 20px;
            color: #777;
        }
        .logo-container {
            margin-bottom: 20px;
        }
        .logo-container img {
            max-width: 100%;
            height: auto;
        }
        .lab-link {
            color: #3498db;
            text-decoration: none;
        }
        .lab-link:hover {
            text-decoration: underline;
        }
        .input-group {
            margin-top: 20px;
        }
        .input-group input {
            padding: 10px;
            width: calc(100% - 120px);
            border: 1px solid #ccc;
            border-radius: 4px 0 0 4px;
        }
        .input-group button {
            padding: 10px 20px;
            border: 1px solid #ccc;
            background-color: #e74c3c;
            color: white;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }
        .input-group button:hover {
            background-color: #c0392b;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-container">
            <a href="https://www.xlsys.cn" class="lab-link">
                <img src="https://web.xlsys.cn/wp-content/uploads/2020/06/logo.png" alt="小柳实验室 Logo">
            </a>
        </div>
        <h1>IP地址查询</h1>
        <p>请输入要查询的IP地址:</p>
        <div class="input-group">
            <input type="text" id="ip-input" placeholder="例如: 192.168.1.1">
            <button onclick="queryIP()">查询</button>
        </div>
        <p>查询结果:</p>
        <p>IP地址: <span class="ip-address" id="result-ip">加载中...</span></p>
	  <p>IPv6地址: <span class="ipv6-address" id="result-ipv6">加载中...</span></p>
        <p>城市: <span class="ip-city" id="result-ip-city">加载中...</span></p>
        <p>地区: <span class="ip-region" id="result-ip-region">加载中...</span></p>
        <p>国家: <span class="ip-country" id="result-ip-country">加载中...</span></p>
        <p>访问时间: <span class="visit-time" id="result-visit-time">加载中...</span></p>

        <div class="footer">
            <p>© 2024 小柳实验室. 保留所有权利。</p>
        </div>
    </div>

    <script>
        function getVisitTime() {
            const now = new Date();
            return now.toLocaleString();
        }

        function formatCountry(countryCode, countryName) {
            return `${countryCode} | ${countryName}`;
        }

        function validateIP(ip) {
            const ipv4Pattern = /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
            const ipv6Pattern = /^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4})?:)?((25[0-5]|(2[0-4]|1?[0-9])?[0-9])\.){3}(25[0-5]|(2[0-4]|1?[0-9])?[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1?[0-9])?[0-9])\.){3}(25[0-5]|(2[0-4]|1?[0-9])?[0-9]))$/;
            return ipv4Pattern.test(ip) || ipv6Pattern.test(ip);
        }

        function queryIP(ip, apiIndex = 0) {
            const apis = [
                {url: ip ? `https://api.ip.sb/geoip/${ip}` : 'https://api.ip.sb/geoip', key: null},
                {url: ip ? `https://ipinfo.io/${ip}/json` : 'https://ipinfo.io/json', key: null},
                {url: ip ? `https://api.ipify.org?format=json&ip=${ip}` : 'https://api.ipify.org?format=json', key: 'ip'}
            ];

            if (apiIndex >= apis.length) {
                document.getElementById('result-ip').textContent = '无法获取';
                document.getElementById('result-ip-city').textContent = '无法获取';
                document.getElementById('result-ip-region').textContent = '无法获取';
                document.getElementById('result-ip-country').textContent = '无法获取';
                document.getElementById('result-visit-time').textContent = getVisitTime();
                document.getElementById('result-ipv6').textContent = '无法获取';
                alert('无法获取数据，请稍后再试');
                return;
            }

            const api = apis[apiIndex];
            fetch(api.url)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('result-ip').textContent = data.ip || '未知';
                    document.getElementById('result-ip-city').textContent = data.city || '未知';
                    document.getElementById('result-ip-region').textContent = data.region || data.region_name || '未知';
                    document.getElementById('result-ip-country').textContent = formatCountry(data.country || '未知', data.country_name || '未知');
                    document.getElementById('result-visit-time').textContent = getVisitTime();
                    document.getElementById('result-ipv6').textContent = data.ipv6 ? `IPv6: ${data.ipv6}` : '无';

                    // 新增：支持 curl 命令输出 JSON 格式
                    if (window.location.search.includes('mode=curl')) {
                        const result = {
                            ip: data.ip || '未知',
                            city: data.city || '未知',
                            region: data.region || data.region_name || '未知',
                            country: formatCountry(data.country || '未知', data.country_name || '未知'),
                            visit_time: getVisitTime(),
                            ipv6: data.ipv6 ? `IPv6: ${data.ipv6}` : '无'
                        };
                        console.log(JSON.stringify(result, null, 2));
                    }
                })
                .catch(error => {
                    console.error(`Error fetching IP details from API ${apiIndex + 1}:`, error);
                    queryIP(ip, apiIndex + 1); // 尝试下一个API
                });
        }

        // 页面加载时查询当前访问者的IP地址
        window.onload = function() {
            queryIP();
        };

        // 添加输入验证和查询功能
        document.querySelector('.input-group button').addEventListener('click', function() {
            const ipInput = document.getElementById('ip-input').value.trim();
            if (!validateIP(ipInput)) {
                alert('请输入有效的 IP 地址');
                return;
            }
            queryIP(ipInput);
        });

        // 新增：处理 curl 请求
        if (window.location.search.includes('mode=curl')) {
            queryIP();
            setTimeout(() => {
                window.close(); // 关闭页面以避免干扰终端输出
            }, 1000);
        }
    </script>
</body>
</html>